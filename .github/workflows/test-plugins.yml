name: Test Plugins

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Discovery job - outputs plugin matrix dynamically
  discover:
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.discover.outputs.plugins }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover plugins with tests
        id: discover
        run: |
          # Find all plugins with tests directory (skip symlinks)
          plugins=$(find plugins -maxdepth 1 -mindepth 1 -type d ! -type l -exec test -d {}/tests \; -print | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "plugins=$plugins" >> $GITHUB_OUTPUT
          echo "Discovered plugins: $plugins"

  # Test each plugin in parallel
  test:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        plugin: ${{ fromJson(needs.discover.outputs.plugins) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-timeout
          pip install -e plugins/${{ matrix.plugin }}

      - name: Run unit tests for ${{ matrix.plugin }}
        run: |
          pytest plugins/${{ matrix.plugin }}/tests -v -m "not slow" --timeout=30

  # Integration tests (only on master push, with API keys)
  integration-tests:
    needs: discover
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.discover.outputs.plugins) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pytest pytest-timeout
          pip install -e plugins/${{ matrix.plugin }}

      - name: Run integration tests for ${{ matrix.plugin }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -d "plugins/${{ matrix.plugin }}/tests/integration" ]; then
            pytest plugins/${{ matrix.plugin }}/tests/integration -v --timeout=120
          else
            echo "No integration tests found for ${{ matrix.plugin }}"
          fi

  # Coverage report (combined for all plugins)
  coverage:
    needs: discover
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-timeout
          # Install all plugins
          for plugin in plugins/*/; do
            if [ -f "$plugin/pyproject.toml" ]; then
              pip install -e "$plugin"
            fi
          done

      - name: Run coverage
        run: |
          # Find all plugins with tests and run coverage
          for plugin in plugins/*/; do
            if [ -d "$plugin/tests" ]; then
              pytest "$plugin/tests" -v -m "not slow" --cov="$plugin" --cov-append --cov-report=xml --cov-report=term --timeout=30 || true
            fi
          done

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-plugins
