#!/bin/bash
# Post-checkout hook: Validates branch base on branch creation
# Catches issues early (before any commits) that pre-commit would miss

# Arguments:
# $1 - previous HEAD ref
# $2 - new HEAD ref
# $3 - flag: 1 if branch checkout, 0 if file checkout

_prev_head=$1  # Unused but provided by git
_new_head=$2   # Unused but provided by git
is_branch_checkout=$3

# Only run on branch checkouts (not file checkouts)
if [ "$is_branch_checkout" != "1" ]; then
    exit 0
fi

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if [ -z "$current_branch" ] || [ "$current_branch" = "HEAD" ]; then
    exit 0  # Detached HEAD or not in a git repo
fi

# Skip check on master/main branches
if [ "$current_branch" = "master" ] || [ "$current_branch" = "main" ]; then
    exit 0
fi

# Try to fetch origin to ensure we have latest refs (silent)
git fetch origin --quiet 2>/dev/null || true

# Determine origin default branch
origin_default=""
for remote_branch in origin/master origin/main; do
    if git rev-parse --verify "$remote_branch" >/dev/null 2>&1; then
        origin_default="$remote_branch"
        break
    fi
done

if [ -z "$origin_default" ]; then
    exit 0  # Can't find origin default branch
fi

# Get merge base with origin
merge_base=$(git merge-base HEAD "$origin_default" 2>/dev/null || echo "")
if [ -z "$merge_base" ]; then
    exit 0
fi

# Get latest commit on origin
origin_commit=$(git rev-parse "$origin_default" 2>/dev/null || echo "")
if [ -z "$origin_commit" ]; then
    exit 0
fi

# Check if merge base is origin head
if [ "$merge_base" != "$origin_commit" ]; then
    # Calculate how many commits behind
    commits_behind=$(git rev-list --count "$merge_base".."$origin_default" 2>/dev/null || echo "?")

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "⚠️  BRANCH BASE WARNING"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "   Branch '$current_branch' is NOT based on latest $origin_default"
    echo "   This may include unrelated commits from local work!"
    echo ""
    echo "   Your base:     $(git rev-parse --short $merge_base) ($(git log -1 --format='%s' $merge_base | head -c 50))"
    echo "   $origin_default: $(git rev-parse --short $origin_commit) ($(git log -1 --format='%s' $origin_commit | head -c 50))"
    echo "   Behind by:     $commits_behind commit(s)"
    echo ""
    echo "   To fix NOW (before making commits):"
    echo "   └─ git rebase $origin_default"
    echo ""
    echo "   Or create branch correctly:"
    echo "   └─ git checkout -b <branch-name> $origin_default"
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
fi

# Git LFS support (don't fail hook if LFS has issues)
command -v git-lfs >/dev/null 2>&1 && git lfs post-checkout "$@" 2>/dev/null || true

exit 0
